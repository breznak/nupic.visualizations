angular.module("app",["ui.bootstrap"]),angular.module("app").constant("appConfig",{TIMESTAMP:"timestamp",EXCLUDE_FIELDS:[],HEADER_SKIPPED_ROWS:2,ZOOM:"HighlightSelector",NONE_VALUE_REPLACEMENT:0,BUFFER_SIZE:1e4,SLIDING_WINDOW:!1,MAX_FILE_SIZE:5e6,LOCAL_CHUNK_SIZE:65536,REMOTE_CHUNK_SIZE:65536}),angular.module("app").controller("appCtrl",["$scope","$http","$timeout","appConfig",function(e,i,n,a){function t(e,i,n){function t(a,t,l){var o=n.toDomXCoord(a),r=n.toDomXCoord(t),d=r-o;e.fillStype=l,e.fillRect(o,i.y,d,i.h)}function r(e,i,n){for(var t=[],l=o.indexOf(i),r=o.indexOf(a.TIMESTAMP),d=0;d<e.length;d++){var s=e[d];s[l]>=n&&(time=s[r],console.log("found anomaly at "+time+" with value "+s[l]),t.push(time))}return u*=e[1][r]-e[0][r],t}for(var d="rgba(0, 255, 10, 0.1)",u=10,s=r(l,"anomaly_score",.6),f=0;f<s.length;f++)t(s[f]-u,s[f]+u,d);console.log("highlight call")}e.view={fieldState:[],graph:null,dataField:null,optionsVisible:!0,filePath:"",loadedFileName:"",errors:[],loading:!1,windowing:{threshold:a.MAX_FILE_SIZE,show:!1,paused:!1,aborted:!1}};var l=[],o=[],r=[],d={},u=!1,s=0,f=a.SLIDING_WINDOW,p=null,g=!1;e.toggleOptions=function(){e.view.optionsVisible=!e.view.optionsVisible,e.view.graph&&(d.resize=n(function(){e.view.graph.resize()}))},e.getRemoteFile=function(){e.view.windowing.show=!1,e.view.windowing.paused=!1,e.view.windowing.aborted=!1,f=!1,e.$broadcast("fileUploadChange"),e.view.loading=!0,i.head(e.view.filePath,{headers:{Range:"bytes=0-32"}}).then(function(n){206===n.status?i.head(e.view.filePath).then(function(i){var n=i.headers("Content-Length");n>a.MAX_FILE_SIZE&&(f=!0,e.view.windowing.show=!0),m(e.view.filePath)}):w(e.view.filePath)},function(){w(e.view.filePath)})},e.canDownload=function(){var i=e.view.filePath.split("://");return("https"===i[0]||"http"===i[0])&&i.length>1&&i[1].length>0?!0:!1},e.abortParse=function(){angular.isDefined(p)&&angular.isDefined(p.abort)&&(p.abort(),e.view.windowing.paused=!1,e.view.windowing.aborted=!0)},e.pauseParse=function(){angular.isDefined(p)&&angular.isDefined(p.pause)&&(p.pause(),e.view.windowing.paused=!0)},e.resumeParse=function(){angular.isDefined(p)&&angular.isDefined(p.resume)&&(p.resume(),e.view.windowing.paused=!1)},e.getLocalFile=function(i){e.view.filePath=i.target.files[0].name,i.target.files[0].size>a.MAX_FILE_SIZE&&(f=!0,e.view.windowing.show=!0),e.view.loading=!0,E(i.target.files[0])};var h=function(e){var i=e.split("/");return i[i.length-1]},v=function(i){for(var n=-1,t=0;t<i.length;t++){for(var d=[],p=0;p<o.length;p++){var h=o[p],v=i[t][h];h===a.TIMESTAMP?(u?v=s++:"number"==typeof v||("string"==typeof v&&null!==b(v)?v=b(v):(S("Parsing timestamp failed, fallback to using iteration number","warning",!0),v=s)),n>=v&&S("Your time is not monotonic at row "+t+"! Graphs are incorrect.","danger",!1),n=v):"None"===v&&(v=a.NONE_VALUE_REPLACEMENT),d.push(v)}f&&l.length>a.BUFFER_SIZE&&(l.shift(),r.shift()),l.push(d),r.push(angular.extend([],d))}null===e.view.graph?I():e.view.graph.updateOptions({file:l}),g||(e.$apply(),g=!0)},c=function(){e.view.fieldState.length=0,e.view.graph=null,e.view.dataField=null,e.view.errors.length=0,e.view.loadedFileName="",u=!1,s=0,l.length=0,o.length=0,g=!1},w=function(i){c(),Papa.parse(i,{download:!0,skipEmptyLines:!0,header:!0,dynamicTyping:!0,worker:!1,comments:"#",complete:function(n){angular.isDefined(n.data)?(e.view.loadedFileName=h(i),o=C(n.data,a.EXCLUDE_FIELDS),n.data.splice(0,a.HEADER_SKIPPED_ROWS),v(n.data)):S("An error occurred when attempting to download file.","danger"),e.view.loading=!1,e.$apply()},error:function(i){e.view.loading=!1,S("Could not download file.","danger")}})},m=function(i){c(),Papa.RemoteChunkSize=a.REMOTE_CHUNK_SIZE;var n=!1;Papa.parse(i,{download:!0,skipEmptyLines:!0,header:!0,dynamicTyping:!0,worker:!1,comments:"#",chunk:function(e,i){n||(p=i,o=C(e.data,a.EXCLUDE_FIELDS),n=!0),v(e.data)},beforeFirstChunk:function(n){e.view.loadedFileName=h(i);var t=n.split(/\r\n|\r|\n/);return t.splice(1,a.HEADER_SKIPPED_ROWS),e.view.loading=!1,t.join("\n")},error:function(i){S("Could not stream file.","danger"),e.view.loading=!1}})},E=function(i){c(),Papa.LocalChunkSize=a.LOCAL_CHUNK_SIZE;var n=!1;Papa.parse(i,{skipEmptyLines:!0,header:!0,dynamicTyping:!0,worker:!1,comments:"#",chunk:function(e,i){n||(p=i,o=C(e.data,a.EXCLUDE_FIELDS),n=!0),v(e.data)},beforeFirstChunk:function(n){e.view.loadedFileName=i.name;var t=n.split(/\r\n|\r|\n/);return t.splice(1,a.HEADER_SKIPPED_ROWS),e.view.loading=!1,t.join("\n")},error:function(i){S(i,"danger"),e.view.loading=!1}})},S=function(i,n,a){if(a="undefined"!=typeof a?a:!1,exists=!1,a){errs=e.view.errors;for(var t=0;t<errs.length;t++)if(errs[t].message===i)return}e.view.errors.push({message:i,type:n}),e.$apply()};e.clearErrors=function(){e.view.errors.length=0},e.clearError=function(i){e.view.errors.splice(i,1)};var b=function(e){var i=new Date(e);if("Invalid Date"!==i.toString())return i;var n=String(e).split(" "),a=[],t=n[0].split("/"),l=n[0].split("-");if(1===t.length&&1===l.length||t.length>1&&l.length>1)return S("Could not parse the timestamp","warning",!0),null;if(l.length>2)a.push(l[0]),a.push(l[1]),a.push(l[2]);else{if(!(t.length>2))return S("There was something wrong with the date in the timestamp field.","warning",!0),null;a.push(t[2]),a.push(t[0]),a.push(t[1])}if(n[1]){var o=n[1].split(":");a=a.concat(o)}for(var r=0;r<a.length;r++)a[r]=parseInt(a[r]);return i=new Function.prototype.bind.apply(Date,[null].concat(a)),"Invalid Date"===i.toString()?(S("The timestamp appears to be invalid.","warning",!0),null):i};e.normalizeField=function(i){var n=i+1;if(null===e.view.dataField)return void console.warn("No data field is set");for(var a=parseInt(e.view.dataField)+1,t=function(e,i){return Math[i].apply(null,e)},o=[],r=[],d=0;d<l.length;d++)"number"==typeof l[d][a]&&"number"==typeof l[d][n]&&(o.push(l[d][a]),r.push(l[d][n]));for(var u=t(o,"max")-t(o,"min"),s=t(r,"max")-t(r,"min"),f=u/s,p=0;p<l.length;p++)l[p][n]=parseFloat((l[p][n]*f).toFixed(10));e.view.graph.updateOptions({file:l})},e.denormalizeField=function(i){for(var n=i+1,a=0;a<l.length;a++)l[a][n]=r[a][n];e.view.graph.updateOptions({file:l})},e.renormalize=function(){for(var i=0;i<e.view.fieldState.length;i++)e.view.fieldState[i].normalized&&e.normalizeField(e.view.fieldState[i].id)};var y=function(i,n){for(var a=0;a<e.view.fieldState.length;a++)if(e.view.fieldState[a].name===i){e.view.fieldState[a].value=n;break}},F=function(i){for(var n=0;n<i.length;n++)e.view.fieldState[n].color=i[n]},C=function(e,i){var n=e[e.length-2];n.hasOwnProperty(a.TIMESTAMP)||(S("No timestamp field was found, using iterations instead","info"),u=!0);var t=[];return angular.forEach(n,function(e,n){"number"==typeof e&&-1===i.indexOf(n)&&n!==a.TIMESTAMP&&t.push(n)}),t.unshift(a.TIMESTAMP),t};e.toggleVisibility=function(i){e.view.graph.setVisibility(i.id,i.visible),i.visible||(i.value=null)},e.showHideAll=function(i){for(var n=0;n<e.view.fieldState.length;n++)e.view.fieldState[n].visible=i,e.view.graph.setVisibility(e.view.fieldState[n].id,i),i||(e.view.fieldState[n].value=null)};var I=function(){var i=document.getElementById("dataContainer");e.view.fieldState.length=0,e.view.dataField=null;for(var n=0,r=u,d=0;d<o.length;d++){var s=o[d];s===a.TIMESTAMP||r?r=!1:(e.view.fieldState.push({name:s,id:n,visible:!0,normalized:!1,value:null,color:"rgb(0,0,0)"}),n++)}e.view.graph=new Dygraph(i,l,{labels:o,labelsUTC:!1,showLabelsOnHighlight:!1,xlabel:"Time",ylabel:"Values",strokeWidth:1,pointClickCallback:function(e,i){timestamp=moment(i.xval),timestampString=timestamp.format("YYYY-MM-DD HH:mm:ss.SSS000"),window.prompt("Copy to clipboard: Ctrl+C, Enter",timestampString)},animatedZooms:!0,showRangeSelector:"RangeSelector"===a.ZOOM,highlightCallback:function(i,n,a,t,l){for(var o=0;o<a.length;o++)y(a[o].name,a[o].yval);e.$apply()},drawCallback:function(e,i){i&&F(e.getColors())},underlayCallback:t})};e.$on("$destroy",function(){angular.forEach(d,function(e){n.cancel(e)})})}]),angular.module("app").directive("fileUploadChange",function(){return{restrict:"A",link:function(e,i,n){var a=e.$eval(n.fileUploadChange);i.on("change",a);var t=e.$on("fileUploadChange",function(){angular.element(i).val(null)});e.$on("$destroy",function(){i.off(),t()})}}}),angular.module("app").directive("normalizeFields",function(){return{restrict:"A",scope:!1,template:'<td><input type="checkbox" ng-disabled="field.id === view.dataField || view.dataField === null" ng-model="field.normalized"></td><td><input type="radio" ng-disabled="field.normalized" ng-model="view.dataField" ng-value="{{field.id}}"></td>',link:function(e,i,n){var a={};a.normalized=e.$watch("field.normalized",function(i,n){i?e.normalizeField(e.field.id):i||i===n||e.denormalizeField(e.field.id)}),a.isData=e.$watch("view.dataField",function(){e.renormalize()}),e.$on("$destroy",function(){angular.forEach(a,function(e){e()})})}}}),angular.module("app").filter("bytes",function(){return function(e,i){if(isNaN(parseFloat(e))||!isFinite(e))return"-";"undefined"==typeof i&&(i=1);var n=["bytes","kB","MB","GB","TB","PB"],a=Math.floor(Math.log(e)/Math.log(1024));return(e/Math.pow(1024,Math.floor(a))).toFixed(i)+" "+n[a]}});